<script>
  document.addEventListener('DOMContentLoaded', loadTasks);

  function normalizeCategory(category) {
    return category.toLowerCase().replace(/\s+&\s+/g, '-').replace(/\s+/g, '-');
  }

  function addTask() {
    const task = document.getElementById('task').value.trim();
    const deadline = document.getElementById('deadline').value;
    const category = document.getElementById('category').value;
    const notification = document.getElementById('notification').value;

    if (!task || !deadline) {
      alert('Please enter both task and deadline');
      return;
    }

    const categoryId = normalizeCategory(category);
    const list = document.querySelector(`#${categoryId} ul`);

    if (!list) {
      alert('Invalid category selected');
      return;
    }

    const listItem = createTaskElement(task, deadline, false, categoryId, notification);
    list.appendChild(listItem);

    saveTask(task, deadline, category, notification, false);

    document.getElementById('task').value = '';
    document.getElementById('deadline').value = '';
  }

  function createTaskElement(taskText, deadline, completed, categoryId, notification) {
    const listItem = document.createElement('li');
    listItem.className = completed ? 'completed' : '';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = completed;
    checkbox.addEventListener('change', () => handleTaskCompletion(checkbox, listItem, taskText, categoryId));

    const label = document.createElement('label');
    label.textContent = `${taskText} (Deadline: ${new Date(deadline).toLocaleString()})`;

    listItem.appendChild(checkbox);
    listItem.appendChild(label);

    scheduleNotification(taskText, deadline, notification);

    return listItem;
  }

  function handleTaskCompletion(checkbox, listItem, taskText, categoryId) {
    const completed = checkbox.checked;
    listItem.className = completed ? 'completed' : '';

    if (completed) {
      setTimeout(() => {
        listItem.remove();
        removeTask(taskText);
      }, 48 * 60 * 60 * 1000); // 48 hours
    }

    updateTaskStatus(taskText, completed);
  }

  function scheduleNotification(taskText, deadline, notificationHours) {
    const deadlineTime = new Date(deadline).getTime();
    const notificationTime = deadlineTime - notificationHours * 60 * 60 * 1000;

    if (notificationTime > Date.now()) {
      setTimeout(() => {
        alert(`Reminder: "${taskText}" is due soon!`);
      }, notificationTime - Date.now());
    }
  }

  function saveTask(task, deadline, category, notification, completed) {
    const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    tasks.push({ task, deadline, category, notification, completed });
    localStorage.setItem('tasks', JSON.stringify(tasks));
  }

  function loadTasks() {
    const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    tasks.forEach(({ task, deadline, category, notification, completed }) => {
      const categoryId = normalizeCategory(category);
      const list = document.querySelector(`#${categoryId} ul`);

      if (list) {
        const listItem = createTaskElement(task, deadline, completed, categoryId, notification);
        list.appendChild(listItem);
      }
    });
  }

  function updateTaskStatus(taskText, completed) {
    const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    const task = tasks.find(t => t.task === taskText);
    if (task) {
      task.completed = completed;
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }
  }

  function removeTask(taskText) {
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
    tasks = tasks.filter(t => t.task !== taskText);
    localStorage.setItem('tasks', JSON.stringify(tasks));
  }

  function clearAll() {
    if (confirm('Are you sure you want to delete all tasks?')) {
      localStorage.removeItem('tasks');
      document.querySelectorAll('.card ul').forEach(ul => (ul.innerHTML = ''));
    }
  }
</script>
